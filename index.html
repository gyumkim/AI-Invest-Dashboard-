<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI 투자 대시보드 (Gemini API)</title>
    <style>
        /* CSS 시작 */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: #0d1117;
            color: #c9d1d9;
            margin: 0;
            padding: 20px;
        }

        .dashboard-container {
            max-width: 1200px;
            margin: auto;
            border: 1px solid #30363d;
            border-radius: 8px;
            padding: 20px;
            background-color: #161b22;
        }

        .header {
            text-align: center;
            margin-bottom: 20px;
        }

        .main-content {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
        }

        .chart-section, .info-panel {
            border: 1px solid #30363d;
            border-radius: 6px;
            padding: 15px;
        }

        .chart-section {
            background-color: #010409;
        }

        .chart-placeholder {
            height: 400px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5em;
            color: #4a545e;
            text-align: center;
        }

        .info-panel {
            display: grid;
            grid-template-rows: repeat(3, 1fr);
            gap: 15px;
            background-color: #1c2128;
        }

        h2 {
            margin-top: 0;
            border-bottom: 1px solid #30363d;
            padding-bottom: 5px;
        }

        ul {
            list-style-type: none;
            padding: 0;
            margin: 0;
        }

        li {
            padding: 8px 0;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        li:hover {
            background-color: #30363d;
        }

        .stock-list li {
            display: flex;
            justify-content: space-between;
        }

        .stock-change {
            font-weight: bold;
        }

        .stock-change.positive {
            color: #34d399; /* Green */
        }

        .stock-change.negative {
            color: #f87171; /* Red */
        }

        .discussion-section {
            display: grid;
            grid-template-rows: auto 1fr auto;
            gap: 10px;
        }

        .discussion-box {
            height: 150px;
            overflow-y: auto;
            padding: 10px;
            background-color: #0d1117;
            border: 1px solid #30363d;
            border-radius: 4px;
        }

        .message {
            margin-bottom: 5px;
        }
        
        .user-message {
            text-align: right;
        }

        .ai-message {
            text-align: left;
        }

        .chat-input {
            display: flex;
            gap: 10px;
        }

        .chat-input input {
            flex-grow: 1;
            padding: 8px;
            border: 1px solid #30363d;
            border-radius: 4px;
            background-color: #0d1117;
            color: #c9d1d9;
        }

        .chat-input button {
            background-color: #38a169;
            color: #fff;
            border: none;
            border-radius: 4px;
            padding: 8px 12px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .chat-input button:hover {
            background-color: #277953;
        }

        .summary-btn {
            background-color: #38a169;
            color: #fff;
            padding: 8px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s;
            margin-top: 10px;
        }

        .summary-btn:hover {
            background-color: #277953;
        }

        .loader {
            display: none;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 2s linear infinite;
            margin-left: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .news-item {
            cursor: pointer;
            padding: 8px 0;
        }

        .news-item:hover {
            background-color: #2d343c;
        }

        .popup {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            justify-content: center;
            align-items: center;
        }

        .popup-content {
            background-color: #1c2128;
            padding: 20px;
            border-radius: 8px;
            width: 80%;
            max-height: 80%;
            overflow-y: auto;
            position: relative;
        }

        .close-btn {
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 24px;
            cursor: pointer;
            color: #c9d1d9;
        }
        /* CSS 끝 */
    </style>
</head>
<body>
    <div class="dashboard-container">
        <header class="header">
            <h1>AI Investment Dashboard 📊</h1>
        </header>

        <main class="main-content">
            <div class="chart-section">
                <h2>주식 차트</h2>
                <div class="chart-placeholder">
                    <span>(인터랙티브 차트 영역)<br>종목을 클릭하여 자세한 차트를 확인하세요.</span>
                </div>
            </div>

            <div class="info-panel">
                <div class="stock-list">
                    <h2>주요 지수/종목</h2>
                    <ul id="stock-list">
                        <li data-stock="stock1">
                            <span class="stock-name">S&P 500</span>
                            <span class="stock-price">5,200.50</span>
                            <span class="stock-change positive">+0.85%</span>
                        </li>
                        <li data-stock="stock2">
                            <span class="stock-name">NASDAQ</span>
                            <span class="stock-price">18,345.10</span>
                            <span class="stock-change negative">-0.55%</span>
                        </li>
                        <li data-stock="stock3">
                            <span class="stock-name">Apple (AAPL)</span>
                            <span class="stock-price">220.15</span>
                            <span class="stock-change positive">+1.20%</span>
                        </li>
                    </ul>
                </div>
                <div class="news-section">
                    <h2>AI 기반 뉴스 요약 📰</h2>
                    <ul id="news-list">
                        <li class="news-item" data-full-text="최근 발표된 보고서에 따르면, 인공지능(AI) 기술이 반도체 산업의 새로운 성장 동력으로 강력하게 부상하고 있습니다. AI 칩 수요는 급증하고 있으며, 이는 기존 반도체 시장의 규모를 훨씬 뛰어넘는 잠재력을 보여주고 있습니다. NVIDIA, AMD와 같은 기업들이 AI 칩 시장을 선도하며 새로운 투자의 기회를 창출하고 있습니다.">AI, 반도체 산업의 새로운 성장 동력으로 부상</li>
                        <li class="news-item" data-full-text="Apple(AAPL)이 구글 제미니 AI를 Siri에 통합하는 방안을 논의 중이라는 소식이 전해졌습니다. 이는 Apple의 AI 전략에 큰 변화를 가져올 수 있는 중요한 움직임으로, 양사 간의 협력 가능성에 투자자들의 이목이 집중되고 있습니다.">Apple, 구글 Gemini AI 탑재 Siri에 통합 논의</li>
                        <li class="news-item" data-full-text="Apple은 차세대 아이폰과 맥북을 공개하며 시장의 기대를 뛰어넘는 성능을 선보였습니다. 특히, 새로운 AI 기능이 탑재된 운영체제는 사용자 경험을 혁신적으로 개선할 것으로 예상됩니다. 전문가들은 이번 신제품 발표가 Apple의 주가에 긍정적인 영향을 미칠 것으로 분석하고 있습니다.">Apple, 신제품 발표로 시장 예상치 상회</li>
                        <li class="news-item" data-full-text="미국 연방준비제도(Fed)의 다음 금리 인상 또는 인하 결정이 임박했습니다. 이번 발표는 전 세계 금융 시장에 큰 영향을 미칠 것으로 보입니다. 투자자들은 Fed의 발표 내용을 주시하며 포트폴리오를 조정하고 있으며, 시장의 변동성이 확대될 가능성이 높습니다.">연준 금리 발표 임박, 시장 변동성 확대</li>
                    </ul>
                </div>
                <div class="discussion-section">
                    <h2>로봇과 토론 🧠</h2>
                    <div class="discussion-box" id="discussion-box">
                        <div class="message ai-message">
                            <strong>AI_Bot:</strong> 무엇이 궁금하신가요? 시장 동향이나 특정 종목에 대해 질문해주세요.
                        </div>
                    </div>
                    <div class="chat-input">
                        <input type="text" id="user-input" placeholder="질문을 입력하세요...">
                        <button id="send-btn">전송</button>
                    </div>
                    <button class="summary-btn" id="market-analysis-btn">시장 동향 분석하기</button>
                    <div id="loader" class="loader"></div>
                </div>
            </div>
        </main>
    </div>

    <div id="popup" class="popup">
        <div class="popup-content">
            <span class="close-btn" id="close-popup">&times;</span>
            <h3 id="popup-title"></h3>
            <p id="popup-text"></p>
        </div>
    </div>

    <script>
        // JavaScript 시작
        document.addEventListener('DOMContentLoaded', () => {
            const stockList = document.getElementById('stock-list');
            const newsList = document.getElementById('news-list');
            const marketAnalysisBtn = document.getElementById('market-analysis-btn');
            const discussionBox = document.getElementById('discussion-box');
            const loader = document.getElementById('loader');
            const chartPlaceholder = document.querySelector('.chart-placeholder span');
            const userInput = document.getElementById('user-input');
            const sendBtn = document.getElementById('send-btn');

            const popup = document.getElementById('popup');
            const popupTitle = document.getElementById('popup-title');
            const popupText = document.getElementById('popup-text');
            const closePopupBtn = document.getElementById('close-popup');

            const stockData = {
                'stock1': 'S&P 500 차트입니다. (실제 데이터 연동 필요)',
                'stock2': 'NASDAQ 차트입니다. (실제 데이터 연동 필요)',
                'stock3': 'Apple (AAPL) 차트입니다. (실제 데이터 연동 필요)'
            };

            stockList.addEventListener('click', (event) => {
                const clickedItem = event.target.closest('li');
                if (clickedItem) {
                    const stockId = clickedItem.getAttribute('data-stock');
                    const newChartText = stockData[stockId] || '차트를 불러올 수 없습니다.';
                    chartPlaceholder.textContent = newChartText;
                }
            });

            // 뉴스 요약 기능
            newsList.addEventListener('click', async (event) => {
                const newsItem = event.target.closest('li');
                if (newsItem) {
                    const fullText = newsItem.getAttribute('data-full-text');
                    const newsTitle = newsItem.textContent;
                    
                    loader.style.display = 'inline-block';
                    popupTitle.textContent = newsTitle;
                    popupText.textContent = '뉴스 요약 중... 잠시만 기다려주세요.';
                    popup.style.display = 'flex';

                    try {
                        const prompt = `다음 뉴스 기사를 한 문장으로 간결하게 요약해 주세요: "${fullText}"`;
                        const summary = await callGeminiAPI(prompt);
                        
                        popupText.textContent = summary;
                    } catch (error) {
                        popupTitle.textContent = '오류 발생';
                        popupText.textContent = '요약에 실패했습니다. 다시 시도해 주세요.';
                        console.error('Gemini API 호출 오류:', error);
                    } finally {
                        loader.style.display = 'none';
                    }
                }
            });

            // 로봇과 토론 기능
            const sendMessage = async () => {
                const userMessage = userInput.value.trim();
                if (userMessage === '') return;

                // 사용자 메시지를 토론 상자에 추가
                const userMsgElement = document.createElement('div');
                userMsgElement.classList.add('message', 'user-message');
                userMsgElement.innerHTML = `<strong>사용자:</strong> ${userMessage}`;
                discussionBox.appendChild(userMsgElement);
                userInput.value = '';
                discussionBox.scrollTop = discussionBox.scrollHeight;

                // AI 응답 로딩 표시
                const aiLoadingElement = document.createElement('div');
                aiLoadingElement.classList.add('message', 'ai-message');
                aiLoadingElement.innerHTML = `<strong>AI_Bot:</strong> ...`;
                discussionBox.appendChild(aiLoadingElement);
                discussionBox.scrollTop = discussionBox.scrollHeight;

                try {
                    const prompt = `당신은 투자 시장의 동향을 전문적으로 분석하는 AI 챗봇입니다. 다음 사용자의 질문에 대해 전문적이고 간결하게 답변해주세요: "${userMessage}"`;
                    const aiResponse = await callGeminiAPI(prompt);

                    // 로딩 메시지를 실제 응답으로 교체
                    aiLoadingElement.innerHTML = `<strong>AI_Bot:</strong> ${aiResponse}`;
                } catch (error) {
                    aiLoadingElement.innerHTML = `<strong>AI_Bot:</strong> 죄송합니다. 지금은 답변을 드릴 수 없습니다.`;
                    console.error('Gemini API 호출 오류:', error);
                } finally {
                    discussionBox.scrollTop = discussionBox.scrollHeight;
                }
            };
            
            sendBtn.addEventListener('click', sendMessage);
            userInput.addEventListener('keypress', (event) => {
                if (event.key === 'Enter') {
                    sendMessage();
                }
            });


            // 시장 동향 분석 기능 (로봇 토론 내용 포함)
            marketAnalysisBtn.addEventListener('click', async () => {
                const discussionText = discussionBox.innerText;
                const newsText = Array.from(document.querySelectorAll('#news-list li'))
                                    .map(item => item.textContent.trim())
                                    .join('; ');

                const prompt = `현재 대시보드에 표시된 토론 내용과 시장 뉴스를 종합하여 AI 투자 시장의 전반적인 동향을 한 문단으로 분석하고, 향후 전망에 대한 의견을 제시해 주세요.
                
                <토론 내용>
                ${discussionText}
                
                <시장 뉴스>
                ${newsText}
                `;

                loader.style.display = 'inline-block';
                popupTitle.textContent = '시장 동향 분석 중...';
                popupText.textContent = '잠시만 기다려주세요.';
                popup.style.display = 'flex';
                
                try {
                    const analysis = await callGeminiAPI(prompt);
                    popupTitle.textContent = '오늘의 시장 동향 분석';
                    popupText.textContent = analysis;
                } catch (error) {
                    popupTitle.textContent = '오류 발생';
                    popupText.textContent = '분석에 실패했습니다. 다시 시도해 주세요.';
                    console.error('Gemini API 호출 오류:', error);
                } finally {
                    loader.style.display = 'none';
                }
            });

            // 팝업 닫기
            closePopupBtn.addEventListener('click', () => {
                popup.style.display = 'none';
            });
            window.addEventListener('click', (event) => {
                if (event.target === popup) {
                    popup.style.display = 'none';
                }
            });

            // Gemini API 호출 함수
            async function callGeminiAPI(prompt) {
                const apiKey = "AIzaSyBFzE8yoVdxLcHfnjGuYDKoMWDVh4K1J0Y";a 여기에 실제 Gemini API 키를 넣어주세요.

                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${apiKey}`;
                
                let response = null;
                let retryCount = 0;
                const maxRetries = 5;
                let delay = 1000;

                while (retryCount < maxRetries) {
                    try {
                        response = await fetch(apiUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                        });

                        if (response.ok) {
                            const result = await response.json();
                            if (result.candidates && result.candidates.length > 0) {
                                return result.candidates[0].content.parts[0].text;
                            }
                        }

                        if (response.status === 429) {
                            console.log(`Rate limit exceeded. Retrying in ${delay}ms...`);
                            await new Promise(res => setTimeout(res, delay));
                            delay *= 2;
                            retryCount++;
                        } else {
                            throw new Error(`API returned status code ${response.status}`);
                        }

                    } catch (error) {
                        console.error('API call failed:', error);
                        throw error;
                    }
                }
                throw new Error('Max retries exceeded. Failed to get a response from the API.');
            }
        });
        // JavaScript 끝
    </script>
</body>
</html>
